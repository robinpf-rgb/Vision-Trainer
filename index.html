<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vision Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f0f0f">

    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">

    <style>
        /* All your existing styles stay exactly the same */
        :root {
            --bg-color: #0f0f0f;
            --panel-bg: rgba(25, 25, 25, 0.98);
            --accent: #0088ff;
            --success: #00FF88;
            --danger: #ff4444;
            --text: #ffffff;
            --text-dim: #999;
            --border: #333;
        }

        body, html { 
            margin: 0; padding: 0; overflow: hidden; background: var(--bg-color); 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height: 100%; width: 100%; 
            color: var(--text); touch-action: auto; -webkit-tap-highlight-color: rgba(0,0,0,0);
        }
        
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }
        #interaction-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; cursor: pointer; }

        #controls {
            position: absolute; top: 0; left: 0; bottom: 0; width: 320px;
            background: var(--panel-bg); padding: 20px; border-right: 1px solid var(--border);
            z-index: 100; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column; gap: 20px; overflow-y: auto;
        }
        @media (max-width: 600px) { #controls { width: 85%; padding: 15px; } }
        #controls.visible { transform: translateX(0); }
        
        #toggleControls {
            position: absolute; top: 20px; left: 20px;
            background: var(--panel-bg); color: white; border: 1px solid var(--border); 
            padding: 10px 18px; cursor: pointer; border-radius: 6px; 
            font-size: 12px; z-index: 200; font-weight: bold; letter-spacing: 1px;
        }
        #toggleControls.hidden { display: none; }
        #controls.visible ~ #toggleControls { display: block !important; }

        .section { display: flex; flex-direction: column; gap: 10px; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
        .section-header { font-size: 10px; color: var(--accent); font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 5px; }
        .control-group { display: flex; flex-direction: column; gap: 6px; }
        
        label { font-size: 11px; color: var(--text-dim); display: flex; justify-content: space-between; align-items: center; }
        .val-display { color: var(--accent); font-weight: bold; font-family: monospace; font-size: 12px; }
        
        input[type="range"] { 
            width: 100%; cursor: pointer; accent-color: var(--accent); height: 28px;
            background: transparent;
            background-image: repeating-linear-gradient(to right, #444, #444 1px, transparent 1px, transparent 10%);
            background-size: 98% 8px;
            background-repeat: no-repeat;
            background-position: center bottom;
            margin-bottom: 8px;
            -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-runnable-track { height: 4px; background: #333; border-radius: 2px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: var(--accent); margin-top: -7px; box-shadow: 0 0 5px rgba(0,0,0,0.5); }

        input[type="number"], select { background: #111; color: white; border: 1px solid var(--border); padding: 8px; border-radius: 4px; font-size: 14px; }
        button { cursor: pointer; border-radius: 4px; border: 1px solid var(--border); padding: 10px; font-weight: bold; font-size: 12px; transition: 0.2s; }
        .btn-export { background: #333; color: var(--success); border-color: var(--success); margin-top: 5px; }

        #goal-container { background: #111; padding: 12px; border-radius: 8px; border: 1px solid var(--border); }
        #progress-bg { width: 100%; height: 8px; background: #222; border-radius: 4px; margin-top: 8px; overflow: hidden; }
        #progress-fill { width: 0%; height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); transition: width 0.8s; }

        #hud-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 50; pointer-events: none; }
        .btn-large { padding: 18px 36px; font-size: 16px; font-weight: bold; cursor: pointer; border-radius: 50px; border: none; min-width: 220px; pointer-events: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        #summary-screen { display: none; flex-direction: column; align-items: center; gap: 20px; background: rgba(15, 15, 15, 0.98); padding: 40px 30px; border-radius: 20px; border: 1px solid var(--border); pointer-events: auto; text-align: center; width: 280px; }
        #startBtnCenter { background: var(--accent); color: white; }
        #hudStop { background: var(--danger); color: white; }
        #hudPause { background: var(--panel-bg); color: white; border: 1px solid #444; }
        #history-list { font-size: 11px; color: #777; max-height: 180px; overflow-y: auto; margin-top: 10px; }
        .log-entry { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #1a1a1a; }
        .cycle-label { color: var(--success); font-weight: bold; }
    </style>
</head>
<body>
    <div id="controls">
        <div style="margin-top: 50px;"></div>
        <div class="section">
            <div class="section-header">Appearance</div>
            <div class="control-group">
                <label>Object Shape</label>
                <select id="shapeSelect" onchange="saveSettings()">
                    <option value="bar">Bar</option>
                    <option value="ball">Ball</option>
                    <option value="swarm">Swarm of Balls</option>
                    <option value="triangle">Triangle</option>
                    <option value="stars">Star Cluster</option>
                </select>
            </div>
            <div class="control-group">
                <label>Orientation</label>
                <select id="modeSelect" onchange="saveSettings()">
                    <option value="vertical">vertical</option>
                    <option value="horizontal">horizontal</option>
                </select>
            </div>
            <div class="control-group">
                <label>Object Size <span id="sizeVal" class="val-display">108</span></label>
                <input type="range" id="sizeSlider" min="1" max="216" value="108" oninput="updateRangeLabels()">
            </div>
            <div class="control-group">
                <label>Movement Speed <span id="speedVal" class="val-display">5.5</span></label>
                <input type="range" id="speedSlider" min="1" max="10" step="0.1" value="5.5" oninput="updateRangeLabels()">
            </div>
            <div style="display:flex; align-items:center; gap:12px; padding: 5px 0;"><input type="checkbox" id="smoothToggle" onchange="saveSettings()" style="width:18px; height:18px;"><label>Acceleration Mode</label></div>
        </div>

        <div class="section">
            <div class="section-header">Session Timers</div>
            <div class="control-group"><label>Daily Goal (Min)</label><input type="number" id="dailyGoalMin" value="30" onchange="saveSettings()"></div>
            <div class="control-group"><label>Session Block Time (Min)</label><input type="number" id="workoutMin" value="10" onchange="updateCountdownOnly()"></div>
            <div class="control-group">
                <label>Random Bar Life (Sec)</label>
                <div style="display:flex; gap:5px;"><input type="number" id="minSec" value="60" style="width:100%;" onchange="saveSettings()"><input type="number" id="maxSec" value="90" style="width:100%;" onchange="saveSettings()"></div>
            </div>
            <div class="control-group">
                <label>Edge Pause (Sec) <span id="pauseVal" class="val-display">0.5</span></label>
                <input type="range" id="edgePauseSlider" min="0" max="1" step="0.05" value="0.5" oninput="updateRangeLabels()">
            </div>
            <div style="display:flex; align-items:center; gap:12px; padding: 5px 0;"><input type="checkbox" id="fullscreenToggle" onchange="saveSettings()" style="width:18px; height:18px;"><label>Auto Fullscreen on Start</label></div>
        </div>

        <div class="section">
            <div class="section-header">Alert Settings</div>
            <div class="control-group"><label>Reaction Window (Sec)</label><input type="number" id="graceInput" value="5" onchange="saveSettings()"></div>
            <div class="control-group">
                <label>Flicker Frequency <span id="flickerVal" class="val-display">250</span></label>
                <input type="range" id="flickerSpeed" min="100" max="400" step="5" value="250" style="direction: rtl;" oninput="updateRangeLabels()">
            </div>
            <div class="control-group">
                <label>Alert Brightness <span id="brightVal" class="val-display">255</span></label>
                <input type="range" id="flickerBright" min="0" max="255" value="255" oninput="updateRangeLabels()">
            </div>
            <button class="btn-large" style="font-size:10px; padding:10px; min-width:100%; border-radius:4px; background:#222; color:var(--accent);" id="testBtn" onclick="toggleFlicker(event)">FLICKER TEST</button>
        </div>

        <div class="section" style="border-bottom:none;">
            <div class="section-header">Performance Log</div>
            <div id="goal-container"><div id="goal-text" style="font-size:11px; font-weight:bold;">Progress: 0:00 / 30:00</div><div id="progress-bg"><div id="progress-fill"></div></div></div>
            <button class="btn-export" onclick="exportLogToCSV()">DOWNLOAD EXCEL (.CSV)</button>
            <div id="history-list"></div>
            <button style="background:transparent; color:#666; font-size:10px; border:none; margin-top:10px;" onclick="clearLog()">CLEAR HISTORY</button>
            <button style="background:transparent; color:#666; font-size:10px; border:none;" onclick="resetDefaults(event)">RESET ALL SETTINGS</button>
        </div>
    </div>

    <button id="toggleControls" onclick="togglePanel(event)">MENU</button>

    <div id="hud-overlay">
        <button id="startBtnCenter" class="btn-large" onclick="handleStartClick(event)">START TRAINING</button>
        <div id="summary-screen">
            <h2 style="margin:0; color:var(--accent); font-size:18px; letter-spacing:1px;">CURRENT SESSION</h2>
            <div style="margin:20px 0;">
                <p id="summary-time" style="font-size:32px; color:white; font-weight:bold; margin:5px 0;">0:00</p>
            </div>
            <button class="btn-large" style="background:var(--accent); margin-bottom:12px;" onclick="keepGoing(event)">KEEP GOING</button>
            <button class="btn-large" style="background:var(--danger);" onclick="finalizeSession(event)">END SESSION</button>
        </div>
        <div id="active-session-hud" style="display:none; flex-direction:column; align-items:center; gap:15px;">
            <div id="session-countdown" style="font-size:32px; font-weight:bold; letter-spacing:2px;"></div>
            <div id="hud-total" style="color:var(--text-dim); font-size:12px; text-transform:uppercase;">Session Total: 0:00</div>
            <div style="display:flex; gap:15px;"><button id="hudPause" class="btn-large" style="min-width:110px;" onclick="togglePause(event)">PAUSE</button><button id="hudStop" class="btn-large" style="min-width:110px;" onclick="stopSession(event)">STOP</button></div>
        </div>
    </div>

    <div id="interaction-layer"></div>
    <canvas id="gameCanvas"></canvas>

    <script>
        // JS remains identical
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const controls = document.getElementById('controls');
        const activeHud = document.getElementById('active-session-hud');
        const summaryScreen = document.getElementById('summary-screen');
        const startBtn = document.getElementById('startBtnCenter');
        const menuBtn = document.getElementById('toggleControls');
        const workoutDisplay = document.getElementById('session-countdown');
        const totalDisplay = document.getElementById('hud-total');
        const interLayer = document.getElementById('interaction-layer');
        const testBtn = document.getElementById('testBtn');

        let bar = { pos: 0, dir: 1, active: false, internalPaused: false, userPaused: false };
        let isWorkoutRunning = false, lastTimestamp = 0;
        let countdownRemaining = 0, totalElapsedSessionTime = 0, cycleCount = 0;
        let barRoundTimeRemaining = 0, isFlickering = false, alertTimer, hudTimer, starField = [];
        let swarmOffs = [{x:0,y:0,t:0}, {x:0,y:0,t:Math.PI}, {x:0,y:0,t:Math.PI/2}]; 

        const controlIds = ['shapeSelect', 'modeSelect', 'smoothToggle', 'sizeSlider', 'speedSlider', 'edgePauseSlider', 'flickerSpeed', 'flickerBright', 'graceInput', 'workoutMin', 'dailyGoalMin', 'fullscreenToggle', 'minSec', 'maxSec'];

        function updateRangeLabels() {
            document.getElementById('sizeVal').innerText = document.getElementById('sizeSlider').value;
            document.getElementById('speedVal').innerText = document.getElementById('speedSlider').value;
            document.getElementById('pauseVal').innerText = document.getElementById('edgePauseSlider').value;
            document.getElementById('flickerVal').innerText = document.getElementById('flickerSpeed').value;
            document.getElementById('brightVal').innerText = document.getElementById('flickerBright').value;
            saveSettings();
        }

        function saveSettings() {
            const settings = {};
            controlIds.forEach(id => { settings[id] = document.getElementById(id).type === 'checkbox' ? document.getElementById(id).checked : document.getElementById(id).value; });
            localStorage.setItem('eye_trainer_pro_final_v1', JSON.stringify(settings));
            updateGoalDisplay();
        }

        function loadSettings() {
            const saved = localStorage.getItem('eye_trainer_pro_final_v1');
            if (saved) {
                const settings = JSON.parse(saved);
                controlIds.forEach(id => { if (settings[id] !== undefined) { const el = document.getElementById(id); if (el.type === 'checkbox') el.checked = settings[id]; else el.value = settings[id]; } });
            }
            updateRangeLabels();
            updateLogDisplay();
        }

        function togglePanel(e) { if
